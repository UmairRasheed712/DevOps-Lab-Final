---
- name: Deploy app stack to Kubernetes
  hosts: local
  gather_facts: false
  vars:
    kubeconfig_path: "{{ lookup('env', 'KUBECONFIG') | default('~/.kube/config', true) }}"
    namespace: dev
    k8s_dir: "{{ playbook_dir }}/../k8s"
  tasks:
    - name: Ensure namespace exists
      kubernetes.core.k8s:
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ namespace }}"

    - name: Apply config and secrets
      kubernetes.core.k8s:
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: "{{ namespace }}"
        src: "{{ item }}"
      loop:
        - "{{ k8s_dir }}/configmap.yaml"
        - "{{ k8s_dir }}/secret.yaml"

    - name: Deploy data services (Redis only)
      kubernetes.core.k8s:
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: "{{ namespace }}"
        src: "{{ item }}"
      loop:
        - "{{ k8s_dir }}/redis.yaml"

    - name: Deploy API
      kubernetes.core.k8s:
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: "{{ namespace }}"
        src: "{{ item }}"
      loop:
        - "{{ k8s_dir }}/api-deployment.yaml"
        - "{{ k8s_dir }}/api-service.yaml"
